<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8"/>
    <title>任务中心</title>
    <script th:src="@{/js/jquery-3.3.1.min.js}" charset="utf-8"></script>
    <script th:src="@{/layui/layui.js}" charset="utf-8"></script>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}"  media="all">
</head>
<body class="layui-layout-body">

<div class="layui-layout layui-layout-admin">

    <div class="layui-header">
        <div class="layui-logo">携华任务管理中心</div>
        <ul class="layui-nav layui-layout-left">
            <li class="layui-nav-item layui-this"><a th:href="@{/index}">定时任务</a></li>
            <li class="layui-nav-item"><a th:href="@{/delay}">延迟任务</a></li>
            <li class="layui-nav-item"><a th:href="@{/log}">任务日志</a></li>
        </ul>
    </div>

    <div style="margin: 20px;">
        <form class="layui-form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">服务名称：</label>
                    <div class="layui-input-inline">
                        <input type="text" name="serviceName" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">类名：</label>
                    <div class="layui-input-inline" style="width: 300px;">
                        <input type="text" name="className"  autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-input-inline">
                        <button class="layui-btn" lay-submit="" lay-filter="query">查询</button>
                    </div>
                </div>
            </div>
        </form>

        <table class="layui-table" lay-data="{url:'/task_server/get_secheduled_task_pager', page:true, id:'secheduleTable'}" lay-filter="nimahai">
            <thead>
            <tr>
                <th lay-data="{field:'id'}">任务ID</th>
                <th lay-data="{field:'serviceName'}">服务名称</th>
                <th lay-data="{field:'className'}">类名</th>
                <th lay-data="{field:'cron'}">表达式</th>
                <th lay-data="{field:'status'}">任务状态</th>
                <th lay-data="{field:'activation'}">激活状态</th>
                <th lay-data="{field:'nextExceTime'}">下次执行时间</th>
                <th lay-data="{field:'exceCount'}">执行次数</th>
                <th lay-data="{toolbar:'#ztoolbar'}">操作</th>
            </tr>
            </thead>
        </table>
        <script type="text/html" id="ztoolbar">
            <a class="layui-btn layui-btn-xs" lay-event="open">开启</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="close">关闭</a>
            <a class="layui-btn layui-btn-xs" lay-event="piece">任务分片</a>
        </script>
    </div>

</div>

</body>

<script>

    //JavaScript代码区域
    var element;
    layui.use('element', function(){
        element= layui.element;
    });

    var sechedule_table;
    layui.use('table', function(){
        sechedule_table = layui.table;
        //监听工具条
        sechedule_table.on('tool(nimahai)', function(obj){
            var data = obj.data;
            if(obj.event === 'open'){
                if(data.status == 'enable') {
                    layer.msg('已是开启状态');
                } else {
                    setSutats(data.id, 'enable');
                }
            } else if(obj.event === 'close'){
                if(data.status == 'disable') {
                    layer.msg('已是关闭状态');
                } else {
                    layer.confirm('确定要关闭任务吗？', function(index){
                        layer.close(index);
                        setSutats(data.id, 'disable');
                    });
                }
            } else if(obj.event === 'piece'){

            }
        });
    });

    function setSutats(taskId, status) {
        var index = layer.load(1);
        $.ajax({
            type: "POST",
            url: "/task_server/update_secheduled_status/" + taskId + "/" + status,
            contentType: "application/json",
            data: JSON.stringify({}),
            success: function(response) {
                sechedule_table.reload('secheduleTable');
                layer.close(index);
            },
            error: function(response) {
                layer.msg('设置失败');
                sechedule_table.reload('secheduleTable');
                layer.close(index);
            }
        });
    }

    layui.use('form', function(){
        var form = layui.form;
        //监听提交
        form.on('submit(query)', function(data){
            sechedule_table.reload('secheduleTable', {
                where: {
                    serviceName: data.field.serviceName,
                    className: data.field.className
                },page: {
                    curr: 1
                }
            });
            return false;
        });
    });

</script>

</html>